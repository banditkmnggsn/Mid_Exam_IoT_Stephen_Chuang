// ============================================================
// ESP32 BLE (Bluetooth Low Energy) TESTING
// Stephen Chuang - 2702269135
// ============================================================
// CODE INI DI-COMMENT DULU
// Untuk testing BLE, uncomment code ini nanti
// ============================================================

/*
// ==================== BLE SERVER (Sender) ====================
// Upload ke ESP32 #1

#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>

#define SERVICE_UUID        "4fafc201-1fb5-459e-8fcc-c5c9c331914b"
#define CHARACTERISTIC_UUID "beb5483e-36e1-4688-b7f5-ea07361b26a8"

BLECharacteristic *pCharacteristic;
bool deviceConnected = false;
uint32_t packetCounter = 0;

class ServerCallbacks: public BLEServerCallbacks {
  void onConnect(BLEServer* pServer) {
    deviceConnected = true;
    Serial.println("✓ Device Connected!");
  }
  
  void onDisconnect(BLEServer* pServer) {
    deviceConnected = false;
    Serial.println("✗ Device Disconnected!");
    delay(500);
    BLEDevice::startAdvertising(); // Restart advertising
    Serial.println("→ Advertising restarted");
  }
};

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n==================================");
  Serial.println("ESP32 BLE SERVER - Testing");
  Serial.println("Stephen Chuang - 2702269135");
  Serial.println("==================================\n");

  // Create BLE Device
  BLEDevice::init("ESP32-BLE-Server");
  
  // Create BLE Server
  BLEServer *pServer = BLEDevice::createServer();
  pServer->setCallbacks(new ServerCallbacks());
  
  // Create BLE Service
  BLEService *pService = pServer->createService(SERVICE_UUID);
  
  // Create BLE Characteristic
  pCharacteristic = pService->createCharacteristic(
    CHARACTERISTIC_UUID,
    BLECharacteristic::PROPERTY_READ |
    BLECharacteristic::PROPERTY_WRITE |
    BLECharacteristic::PROPERTY_NOTIFY
  );
  
  pCharacteristic->addDescriptor(new BLE2902());
  
  // Start service
  pService->start();
  
  // Start advertising
  BLEAdvertising *pAdvertising = BLEDevice::getAdvertising();
  pAdvertising->addServiceUUID(SERVICE_UUID);
  pAdvertising->setScanResponse(true);
  pAdvertising->setMinPreferred(0x06);
  pAdvertising->setMinPreferred(0x12);
  BLEDevice::startAdvertising();
  
  Serial.println("✓ BLE Server started");
  Serial.println("✓ Advertising...");
  Serial.println("\n[Waiting for client connection...]\n");
}

void loop() {
  if (deviceConnected) {
    packetCounter++;
    
    // Prepare packet
    char buffer[32];
    uint32_t timestamp = millis();
    snprintf(buffer, sizeof(buffer), "%lu:%lu", packetCounter, timestamp);
    
    // Send notification
    pCharacteristic->setValue(buffer);
    pCharacteristic->notify();
    
    Serial.print("→ Sent Packet #");
    Serial.print(packetCounter);
    Serial.print(" at ");
    Serial.print(timestamp);
    Serial.println(" ms");
    
    delay(1000); // Send setiap 1 detik
  } else {
    Serial.println("⏳ Waiting for connection...");
    delay(2000);
  }
}
*/

/*
// ==================== BLE CLIENT (Receiver) ====================
// Upload ke ESP32 #2

#include <BLEDevice.h>
#include <BLEUtils.h>
#include <BLEScan.h>
#include <BLEAdvertisedDevice.h>

#define SERVICE_UUID        "4fafc201-1fb5-459e-8fcc-c5c9c331914b"
#define CHARACTERISTIC_UUID "beb5483e-36e1-4688-b7f5-ea07361b26a8"

static BLERemoteCharacteristic* pRemoteCharacteristic;
static BLEAdvertisedDevice* myDevice;
static boolean doConnect = false;
static boolean connected = false;

// Statistics
uint32_t totalPacketsReceived = 0;
uint32_t lastPacketID = 0;
uint32_t totalPacketLoss = 0;
uint32_t totalLatency = 0;
uint32_t minLatency = 999999;
uint32_t maxLatency = 0;

// Callback when notification received
static void notifyCallback(
  BLERemoteCharacteristic* pBLERemoteCharacteristic,
  uint8_t* pData,
  size_t length,
  bool isNotify
) {
  // Parse data: "packetID:timestamp"
  String dataStr = String((char*)pData);
  int separatorIndex = dataStr.indexOf(':');
  
  uint32_t packetID = dataStr.substring(0, separatorIndex).toInt();
  uint32_t sendTime = dataStr.substring(separatorIndex + 1).toInt();
  uint32_t receiveTime = millis();
  uint32_t latency = receiveTime - sendTime;
  
  // Get RSSI
  int rssi = myDevice->getRSSI();
  
  // Update statistics
  totalPacketsReceived++;
  totalLatency += latency;
  
  if (latency < minLatency) minLatency = latency;
  if (latency > maxLatency) maxLatency = latency;
  
  // Check packet loss
  if (packetID > lastPacketID + 1) {
    uint32_t lostPackets = packetID - lastPacketID - 1;
    totalPacketLoss += lostPackets;
    Serial.print("⚠ PACKET LOSS! Lost ");
    Serial.print(lostPackets);
    Serial.println(" packet(s)");
  }
  lastPacketID = packetID;
  
  // Display results
  Serial.println("\n╔═══════════════════════════════════════╗");
  Serial.print("║ Packet #");
  Serial.print(packetID);
  Serial.println(" RECEIVED");
  Serial.println("╠═══════════════════════════════════════╣");
  
  Serial.print("║ Latency    : ");
  Serial.print(latency);
  Serial.println(" ms");
  
  Serial.print("║ RSSI       : ");
  Serial.print(rssi);
  Serial.println(" dBm");
  
  Serial.println("╠═══════════════════════════════════════╣");
  
  Serial.print("║ Total RX   : ");
  Serial.println(totalPacketsReceived);
  
  Serial.print("║ Packet Loss: ");
  Serial.println(totalPacketLoss);
  
  float lossRate = (float)totalPacketLoss / (totalPacketsReceived + totalPacketLoss) * 100.0;
  Serial.print("║ Loss Rate  : ");
  Serial.print(lossRate, 2);
  Serial.println("%");
  
  float avgLatency = (float)totalLatency / totalPacketsReceived;
  Serial.print("║ Avg Latency: ");
  Serial.print(avgLatency, 2);
  Serial.println(" ms");
  
  Serial.print("║ Min Latency: ");
  Serial.print(minLatency);
  Serial.println(" ms");
  
  Serial.print("║ Max Latency: ");
  Serial.print(maxLatency);
  Serial.println(" ms");
  
  float successRate = 100.0 - lossRate;
  Serial.print("║ Success    : ");
  Serial.print(successRate, 2);
  Serial.println("%");
  
  Serial.println("╚═══════════════════════════════════════╝\n");
}

class ClientCallback : public BLEClientCallbacks {
  void onConnect(BLEClient* pclient) {
    connected = true;
    Serial.println("✓ Connected to server!");
  }

  void onDisconnect(BLEClient* pclient) {
    connected = false;
    Serial.println("✗ Disconnected from server!");
  }
};

bool connectToServer() {
  Serial.print("→ Connecting to ");
  Serial.println(myDevice->getAddress().toString().c_str());
  
  BLEClient* pClient = BLEDevice::createClient();
  pClient->setClientCallbacks(new ClientCallback());
  
  pClient->connect(myDevice);
  Serial.println("✓ Connected to server");
  
  // Get service
  BLERemoteService* pRemoteService = pClient->getService(SERVICE_UUID);
  if (pRemoteService == nullptr) {
    Serial.println("✗ Failed to find service UUID");
    pClient->disconnect();
    return false;
  }
  Serial.println("✓ Found service");
  
  // Get characteristic
  pRemoteCharacteristic = pRemoteService->getCharacteristic(CHARACTERISTIC_UUID);
  if (pRemoteCharacteristic == nullptr) {
    Serial.println("✗ Failed to find characteristic UUID");
    pClient->disconnect();
    return false;
  }
  Serial.println("✓ Found characteristic");
  
  // Register for notifications
  if(pRemoteCharacteristic->canNotify()) {
    pRemoteCharacteristic->registerForNotify(notifyCallback);
    Serial.println("✓ Notifications registered");
  }
  
  connected = true;
  return true;
}

class AdvertisedDeviceCallbacks: public BLEAdvertisedDeviceCallbacks {
  void onResult(BLEAdvertisedDevice advertisedDevice) {
    if (advertisedDevice.haveServiceUUID() && 
        advertisedDevice.isAdvertisingService(BLEUUID(SERVICE_UUID))) {
      
      BLEDevice::getScan()->stop();
      myDevice = new BLEAdvertisedDevice(advertisedDevice);
      doConnect = true;
      Serial.println("✓ Found target device!");
    }
  }
};

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n==================================");
  Serial.println("ESP32 BLE CLIENT - Testing");
  Serial.println("Stephen Chuang - 2702269135");
  Serial.println("==================================\n");
  
  BLEDevice::init("ESP32-BLE-Client");
  
  BLEScan* pBLEScan = BLEDevice::getScan();
  pBLEScan->setAdvertisedDeviceCallbacks(new AdvertisedDeviceCallbacks());
  pBLEScan->setInterval(1349);
  pBLEScan->setWindow(449);
  pBLEScan->setActiveScan(true);
  pBLEScan->start(5, false);
  
  Serial.println("✓ Scanning for devices...\n");
}

void loop() {
  if (doConnect) {
    if (connectToServer()) {
      Serial.println("\n[Ready to receive data...]\n");
    } else {
      Serial.println("✗ Connection failed!");
    }
    doConnect = false;
  }
  
  if (!connected) {
    Serial.println("⏳ Not connected, rescanning...");
    BLEDevice::getScan()->start(0);
    delay(5000);
  }
  
  delay(1000);
}
*/

// ============================================================
// PERBANDINGAN BLE vs ESP-NOW
// ============================================================
/*

EXPECTED RESULTS:

┌──────────────┬──────────────┬──────────────┬──────────────┐
│  Parameter   │   ESP-NOW    │     BLE      │   WiFi AP    │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ Max Range    │ 200-300m     │ 30-100m      │ 50-150m      │
│              │ (outdoor)    │ (outdoor)    │ (outdoor)    │
│              │ 50-100m      │ 10-30m       │ 20-50m       │
│              │ (indoor)     │ (indoor)     │ (indoor)     │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ Avg Latency  │ 2-5ms        │ 10-50ms      │ 10-30ms      │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ Success Rate │ 95-100%      │ 90-98%       │ 95-99%       │
│ (optimal)    │              │              │              │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ Power Cons.  │ Medium       │ Very Low     │ High         │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ Max Devices  │ 20 (pairing) │ 7 (active)   │ 100+         │
├──────────────┼──────────────┼──────────────┼──────────────┤
│ Setup        │ Easy         │ Medium       │ Need Router  │
└──────────────┴──────────────┴──────────────┴──────────────┘

KELEBIHAN BLE:
✓ Power consumption paling rendah (cocok untuk battery)
✓ Sudah standard (banyak device support)
✓ Security features built-in
✓ Mesh networking support (BLE Mesh)

KEKURANGAN BLE:
✗ Range lebih pendek
✗ Latency lebih tinggi
✗ Limited active connections (7 devices)
✗ Setup lebih complex

KELEBIHAN ESP-NOW:
✓ Very low latency (2-5ms)
✓ Good range (100m+ outdoor)
✓ Simple peer-to-peer
✓ No router needed
✓ Fast data rate

KEKURANGAN ESP-NOW:
✗ Proprietary (hanya ESP devices)
✗ Power consumption lebih tinggi dari BLE
✗ Limited to 20 paired devices

RECOMMENDATION UNTUK 20-DEVICE HOME AUTOMATION:
→ Gunakan BLE jika prioritas: battery life + standard protocol
→ Gunakan ESP-NOW jika prioritas: latency + reliability
→ Atau kombinasi: BLE untuk sensors (battery), ESP-NOW untuk actuators (powered)

*/